"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReactTreefy=void 0;var _chalk=_interopRequireDefault(require("chalk")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_traverse=_interopRequireDefault(require("@babel/traverse")),_prettyTree=_interopRequireDefault(require("pretty-tree")),_collection=require("lodash/collection"),utils=_interopRequireWildcard(require("./utils"));function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(a,c):{};d.get||d.set?Object.defineProperty(b,c,d):b[c]=a[c]}return b["default"]=a,b}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var ReactTreefy=/*#__PURE__*/function(){function a(b){_classCallCheck(this,a),this.args=b}return _createClass(a,[{key:"run",value:function run(){var a=_path["default"].resolve(this.args.path);return this.isValidPath(a)?(console.log(_chalk["default"].white.bgRed.bold("Generates user-friendly component dependency tree \uD83D\uDE0B... \n")),console.log((0,_prettyTree["default"])(this.buildPrettyTree(a))),0):(console.log(_chalk["default"].red("Please, provide a valid component filename.")),1)}},{key:"buildPrettyTree",value:function buildPrettyTree(a){var b=this;process.chdir(_path["default"].dirname(a));var c=this.parseComponent(a),d=c.name,e=c.children,f=[];return this.isLeafComponent(e)?this.generateLeafNode(d):((0,_collection.forEach)(e||[],function(c){process.chdir(_path["default"].dirname(a)),utils.isRelativePath(c.path)?f.push(b.buildPrettyTree(_path["default"].resolve(c.path))):f.push(b.generateLeafNode(c.component))}),{label:d,nodes:f})}},{key:"parseComponent",value:function parseComponent(a){var b="",c=utils.parseAst(a);if(1===c)return console.log(_chalk["default"].red("Only .js files are allowed!")),1;var d={},e=[],f=_path["default"].basename(a,".js"),g=!1,h="";return(0,_traverse["default"])(c,{enter:function enter(a){var c=a.node;// list the possible import declarations
if(utils.isImportDeclaration(c))// if imported with default syntax
if(utils.isDefaultImport(c.specifiers[0])){if(utils.isRelativePath(c.source.value))try{_fs["default"].accessSync(_path["default"].resolve(utils.appendJsExtension(c.source.value)),_fs["default"].constants.R_OK),d[c.specifiers[0].local.name]=c.source.value}catch(a){d[c.specifiers[0].local.name]="".concat(c.source.value,"/index.js")}else d[c.specifiers[0].local.name]=c.source.value;utils.isReactDomImport(c.source.value)&&(h="reactdom.render")}// if imported with named syntax
else utils.isNamedImport(c.specifiers[0])?((0,_collection.forEach)(c.specifiers||[],function(a){if(utils.isRelativePath(c.source.value))try{_fs["default"].accessSync(_path["default"].resolve(utils.appendJsExtension(c.source.value)),_fs["default"].constants.R_OK),d[a.local.name||a.imported.name]=c.source.value}catch(b){d[a.local.name||a.imported.name]="".concat(c.source.value,"/index.js")}else d[a.local.name||a.imported.name]=c.source.value}),utils.isReactDomImport(c.source.value)&&(h="render")):utils.isArrayEmpty(c.specifiers)||(d[c.specifiers[0].local.name]=c.source.value);// list the possible children components
// find if this is likely to be the root component
if(utils.isJSXElement(c)&&utils.isComponentName(c.openingElement.name.name)&&(e.push(c.openingElement.name.name),(0,_collection.forEach)(c.openingElement.attributes||[],function(a){utils.isJSXExpressionContainer(a.value)&&utils.isComponentName(a.value.expression.name)&&e.push(a.value.expression.name)})),utils.isDefaultExport(c)?utils.isIdentifier(c.declaration)?b=c.declaration.name:utils.isClassDeclaration(c.declaration)?b=c.declaration.id.name:utils.isArrowFunctionExpression(c.declaration)?b=f:utils.isCallExpression(c.declaration)?b=c.declaration.arguments[0].name:b=f:utils.isNamedExport(c)&&utils.isExportSpecifier(c.specifiers[0])&&(b=c.specifiers[0].exported.name||c.specifiers[0].local.name),!g&&utils.isExpressionStatement(c)&&utils.isCallExpression(c.expression)&&h){var i=h.split(".");c.expression.callee&&(c.expression.callee.object&&c.expression.callee.property&&2===i.length&&/reactdom/i.test(c.expression.callee.object.name)&&/render/i.test(c.expression.callee.property.name)?g=!0:1===i.length&&/render/i.test(c.expression.callee.name)&&(g=!0))}}}),{name:g?"Root":b,children:(0,_collection.map)((0,_collection.filter)(e,function(a){return!!d[a]}),function(a){return{component:a,path:d[a]}})}}},{key:"isValidPath",value:function isValidPath(a){var b=_path["default"].extname(a);return!b||utils.isJavascriptExtension(b)}},{key:"isLeafComponent",value:function isLeafComponent(a){return utils.isArrayEmpty(a)}},{key:"generateLeafNode",value:function generateLeafNode(a){return{label:a}}}]),a}();exports.ReactTreefy=ReactTreefy;